{% extends "_layouts/cp" %}
{% import "_includes/forms" as forms %}

{% set plugin = craft.app.plugins.getPlugin('formie-campaigns') %}
{% set settings = plugin.getSettings() %}

{# Site handling #}
{% set siteHandle = craft.app.request.getParam('site') %}
{% set site = siteHandle ? craft.app.getSites().getSiteByHandle(siteHandle) : craft.app.sites.getPrimarySite() %}

{# Get campaign #}
{% set campaign = formieCampaigns.campaigns.find().id(campaignId).siteId(site.id).one() %}
{% if not campaign %}
    {% exit 404 %}
{% endif %}

{% set title = 'Import Customers'|t('formie-campaigns') %}
{% set fullPageForm = false %}
{% set selectedSubnavItem = 'campaigns' %}

{# Site switcher in crumbs #}
{% set crumbs = [] %}
{% if craft.app.getIsMultiSite() %}
    {% set siteMenuItems = [] %}
    {% for s in craft.app.sites.getAllSites() %}
        {% set siteMenuItems = siteMenuItems|merge([{
            label: s.name,
            url: cpUrl('formie-campaigns/' ~ campaignId ~ '/import-customers', {site: s.handle}),
            selected: s.handle == site.handle
        }]) %}
    {% endfor %}

    {% set crumbs = [{
        id: 'site-crumb',
        icon: 'world',
        label: site.name|t('site'),
        menu: {
            items: siteMenuItems,
            label: 'Select site'|t('app')
        }
    }] %}
{% endif %}

{% set crumbs = crumbs|merge([
    { label: settings.pluginName, url: cpUrl('formie-campaigns', {site: site.handle}) },
    { label: campaign.title, url: cpUrl('formie-campaigns/' ~ campaignId ~ '/customers', {site: site.handle}) },
]) %}

{% block content %}
    {% if errors is defined %}
        <div class="pane error" style="margin-bottom: 24px;">
            <p><strong>{{ 'Error:'|t('formie-campaigns') }}</strong></p>
            <p>{{ errors }}</p>
        </div>
    {% endif %}

    <h2 style="margin-top: 0;">{{ 'Import Customers from CSV'|t('formie-campaigns') }}</h2>

    <p>{{ 'Upload a CSV file to import customers into this campaign. You will be able to map columns and preview before importing.'|t('formie-campaigns') }}</p>

    {% set csvFormatTip %}
        <h4>{{ 'CSV Format'|t('formie-campaigns') }}</h4>
        <p><strong>{{ 'Required columns:'|t('formie-campaigns') }}</strong></p>
        <ul>
            <li><code>Name</code> - {{ 'Customer name'|t('formie-campaigns') }}</li>
        </ul>
        <p><strong>{{ 'Optional columns:'|t('formie-campaigns') }}</strong></p>
        <ul>
            <li><code>Email</code> - {{ 'Email address for email invitations'|t('formie-campaigns') }}</li>
            <li><code>Phone</code> / <code>SMS</code> - {{ 'Phone number for SMS invitations'|t('formie-campaigns') }}</li>
            <li><code>Language</code> - {{ 'en or ar (determines site)'|t('formie-campaigns') }}</li>
        </ul>
        <p><strong>{{ 'Example:'|t('formie-campaigns') }}</strong></p>
        <pre style="background: #f3f4f6; padding: 8px; border-radius: 4px; font-size: 12px;">Name,Email,Phone,Language
John Doe,john@example.com,96512345678,en
Ahmed Ali,ahmed@example.com,96598765432,ar</pre>
    {% endset %}

    <div class="field">
        <div class="heading">
            <label>{{ 'CSV File Format'|t('formie-campaigns') }}</label>
            <span class="info">{{ csvFormatTip|raw }}</span>
            <div class="instructions">
                <p>{{ 'Your CSV should include Name, Email, Phone, and Language columns. Click the info icon for details.'|t('formie-campaigns') }}</p>
            </div>
        </div>
    </div>

    <form method="post" action="{{ actionUrl('formie-campaigns/customers/upload') }}" enctype="multipart/form-data">
        {{ csrfInput() }}
        {{ hiddenInput('campaignId', campaignId) }}

        {{ forms.fileField({
            label: 'CSV File'|t('formie-campaigns'),
            instructions: 'Select a CSV file to import customers. Delimiter (comma, semicolon, tab) is auto-detected.'|t('formie-campaigns'),
            id: 'file',
            name: 'file',
            required: true
        }) }}

        {{ forms.lightswitchField({
            label: 'Send Invitations After Import'|t('formie-campaigns'),
            instructions: 'Automatically queue invitation sending after import completes.'|t('formie-campaigns'),
            id: 'queueSending',
            name: 'queueSending',
            on: true,
        }) }}

        <div class="buttons">
            <button type="submit" class="btn submit">{{ 'Upload & Map Columns'|t('formie-campaigns') }}</button>
        </div>
    </form>
{% endblock %}

{% block details %}
    <fieldset>
        <div class="meta">
            <div class="field">
                <div class="heading">
                    <label>{{ 'Campaign'|t('formie-campaigns') }}</label>
                </div>
                <div class="input">
                    <a href="{{ cpUrl('formie-campaigns/' ~ campaignId ~ '/customers', {site: site.handle}) }}">{{ campaign.title }}</a>
                </div>
            </div>

            <div class="field">
                <div class="heading">
                    <label>{{ 'Template'|t('formie-campaigns') }}</label>
                </div>
                <div class="input">
                    <button type="button" class="btn" id="download-template-btn">{{ 'Download CSV Template'|t('formie-campaigns') }}</button>
                </div>
            </div>
        </div>
    </fieldset>
{% endblock %}

{% js %}
document.getElementById('download-template-btn').addEventListener('click', function() {
    var form = document.createElement('form');
    form.method = 'POST';
    form.action = '';
    form.style.display = 'none';

    var csrfInput = document.createElement('input');
    csrfInput.type = 'hidden';
    csrfInput.name = '{{ craft.app.config.general.csrfTokenName }}';
    csrfInput.value = '{{ craft.app.request.csrfToken }}';
    form.appendChild(csrfInput);

    var actionInput = document.createElement('input');
    actionInput.type = 'hidden';
    actionInput.name = 'action';
    actionInput.value = 'formie-campaigns/customers/download-sample';
    form.appendChild(actionInput);

    document.body.appendChild(form);
    form.submit();
});
{% endjs %}
